/** ! pc 2016-05-06 */
!function(){function a(a){var b=ctx+"/plant?_="+(new Date).getTime(),c=null;a&&(c={plantId:a}),x&&(delete x["for"],delete x.plantId),ajaxData(b,c,function(a){if(sessionStorage.setItem("receivePlant",!0),a){var b=DIALOG_TEXT.GET_SEED.replace("$$COUNT$$",a.flow);a.matureDays&&(b=b.replace("$$DAYS$$",a.matureDays+"天")),a.matureHours&&(b=b.replace("$$DAYS$$",a.matureHours+"小时")),w(x,b,DIALOG_ADS.NO_SEEDS),F[a.id]=a,f(a)}else w(x,DIALOG_TEXT.NO_SEEDS,DIALOG_ADS.NO_SEEDS);B=!1})}function b(){var a=ctx+"/getPlants?_="+(new Date).getTime();ajaxData(a,null,function(a){hideToast();for(var b in a)F[a[b].id]=a[b];d(a)},null,"GET")}function c(a){var b=ctx+"/getUserInfo?_="+(new Date).getTime();showToast(),ajaxData(b,null,function(b){$("#user_achievements").html(b.achievements),$("#user_flow").html(b.flow),$("#user_exp").html(b.exp),$(".userName").html(b.name),$(".userPhoto").attr("src",b.photo),a(b)},null,"GET")}function d(a){a&&a.forEach(function(a){f(a)})}function e(){$("#tool-water").on("tap",function(){$(this).hasClass("active")||($(this).addClass("active"),i())}),$("#tool-hand").on("tap",function(){$(this).hasClass("active")||($(this).addClass("active"),k())}),$("#tool-home").on("click",function(){window.location.href="warehouse"}),$("#tool-friends").on("tap",function(){window.location.href="friends"})}function f(a){var b=q(a),c=$(".trees .tree").eq(a.ground);if(c.length){var d=c.children("img.plant");d.removeAttr("class"),d.addClass("plant"),-1!=a.growthStatus&&d.addClass("plant"+(a.growthStatus+1)).attr("src",b),a.ele=d,d.off("singleTap"),d.on("singleTap",function(){a.growthStatus<5&&h(c,$(this),a)})}g(c,a)}function g(a,b){var c,d,e=a.position();if(b.status==E.NEED_WATER?(c=$('<div class="status-icon"></div>'),d=A.water,c.data("target","water_"+b.id)):b.status==E.NEED_HARVEST?(d=A.harvest,c=$('<div class="status-icon"></div>'),c.data("target","harvest_"+b.id)):b.status==E.NEED_ERADICATE&&(d=A.eradicate,c=$('<div class="status-icon"></div>'),c.data("target","eradicate_"+b.id)),c){var f=new Image;f.src=d,f.onload=function(){var b=c.width(),d=c.height();c.css({left:e.left+a.width()/2-b/2,top:e.top-d});var f=null,g=a.children(".plant").width();(0===g||0===b)&&(f=window.setInterval(function(){g=a.children(".plant").width(),b=c.width(),d=c.height(),0!==g&&0!==b&&(window.clearInterval(f),e=a.position(),c.css({left:e.left+a.width()/2-b/2,top:e.top-d}))},10))},c.append(f),$(".ground-grid").append(c),c.on("click",function(){b.status==E.NEED_WATER&&l($(this),b),b.status==E.NEED_HARVEST&&m($(this),b),b.status==E.NEED_ERADICATE&&n($(this),b)})}}function h(a,b,c){if($(".matureStatus",a).length)$(".matureStatus",a).remove();else{var d=ctx+"/getMatureTime/"+c.id+"?_"+(new Date).getTime();ajaxData(d,{plantId:c.id},function(c){var d="剩余";c.matureDays&&(d+=c.matureDays+"天"),c.matureHours&&(d+=c.matureHours+"小时");var e=b.height(),f=a.height(),g=$('<span class="matureStatus">'+d+"</span>");g.css("top",-e+f),a.append(g)},null,"GET")}}function i(){function a(a){i++,i==d.length&&(hideToast(),$("#tool-water").removeClass("active"))}var b=!1;for(var c in F)-1!=F[c].growthStatus&&(b=!0);if(!b)return $("#tool-water").removeClass("active"),void w(x,DIALOG_TEXT.NO_PLANTS,DIALOG_ADS.FAIL);if(0===Object.keys(F).length)return $("#tool-water").removeClass("active"),void w(x,DIALOG_TEXT.NO_PLANTS,DIALOG_ADS.FAIL);showToast();var d=[],e=!1,f=!1;for(var g in F){var h=F[g];h.status==E.NEED_WATER?d.push(h):(h.status==E.NEED_HARVEST&&(e=!0),h.status==E.NEED_ERADICATE&&(f=!0))}var i=0;if(0===d.length)hideToast(),e?w(x,DIALOG_TEXT.WATER_HAS_MATURED,DIALOG_ADS.WATER_HAS_MATURED):f?w(x,DIALOG_TEXT.WATER_DEAD,DIALOG_ADS.FAIL):j(),$("#tool-water").removeClass("active");else for(var k in d){var m=d[k],n=$(".status-icon[data-target='water_"+m.id+"']");l(n,m,!1,a)}}function j(){var a=null;C?(x||(x=u("")),a=x):(y||(y=u("",!0)),a=y),a&&w(a,DIALOG_TEXT.WATER_ALL_WATERED,DIALOG_ADS.WATER_ALL_WATERED)}function k(){function a(a){if(j++,k+=a,j==e.length){hideToast();var b=DIALOG_TEXT.HARVEST_SUCCESS.replace("$$COUNT$$",k);w(x,b,DIALOG_ADS.HARVEST_SUCCESS),$("#tool-hand").removeClass("active")}}var c=!1;for(var d in F)-1!=F[d].growthStatus&&(c=!0);if(!c)return $("#tool-hand").removeClass("active"),void w(x,DIALOG_TEXT.NO_PLANTS,DIALOG_ADS.FAIL);if(0===Object.keys(F).length)return $("#tool-hand").removeClass("active"),void w(x,DIALOG_TEXT.NO_PLANTS,DIALOG_ADS.FAIL);showToast();var e=[],f=!1,g=!1;for(var h in F){var i=F[h];i.status==E.NEED_HARVEST?e.push(i):(f=!0,i.status==E.NEED_ERADICATE&&(g=!0))}var j=0,k=0;if(0===e.length){if(g)w(x,DIALOG_TEXT.HARVEST_DEAD,DIALOG_ADS.FAIL),hideToast();else if(f){var l;o(function(a){hideToast(),a.matureDays&&(l=DIALOG_TEXT.HARVEST_MATURE.replace("$$DAYS$$",a.matureDays+"天"),w(x,l,DIALOG_ADS.HARVEST_MATURE)),a.matureHours&&a.matureHours>0?(l=DIALOG_TEXT.HARVEST_MATURE.replace("$$DAYS$$",a.matureHours+"小时"),w(x,l,DIALOG_ADS.HARVEST_MATURE)):b()})}else hideToast();$("#tool-hand").removeClass("active")}else for(var n in e){var p=e[n],q=$(".status-icon[data-target='harvest_"+p.id+"']");m(q,p,!0,a)}}function l(a,b,c,d){return a.hasClass("clicked")?!1:($(a).addClass("clicked"),showToast(),y||(y=u("",!0)),void $.ajax({url:ctx+"/water/"+b.id+"?_="+(new Date).getTime(),type:"get",dataType:"json",data:{plantId:b.id},success:function(e){if(e.success){if(!c){var f=DIALOG_TEXT.WATER_SUCCESS;f=f.replace("$$AMOUNT$$",e.flow),e.matureDays&&(f=f.replace("$$DAYS$$","浇水"+e.matureDays+"天")),e.matureHours&&(f=f.replace("$$DAYS$$",e.matureHours+"小时")),w(y,f,DIALOG_ADS.WATER_SUCCESS)}b.status=E.NONE,p(),a.remove(),d&&d(e)}else c||w(y,DIALOG_TEXT.FAIL,DIALOG_ADS.FAIL),d&&d();a.removeClass("clicked"),hideToast()},error:function(){hideToast(),a.removeClass("clicked"),c||w(y,DIALOG_TEXT.FAIL,DIALOG_ADS.FAIL),d&&d()}}))}function m(a,b,c,d){return a.hasClass("clicked")?!1:($(a).addClass("clicked"),showToast(),x||(x=u("")),void $.ajax({url:ctx+"/harvest/"+b.id+"?_="+(new Date).getTime(),type:"get",dataType:"json",data:{plantId:b.id},success:function(e){if(e.success){if(!c){var f=DIALOG_TEXT.HARVEST_SUCCESS.replace("$$COUNT$$",e.amount);w(x,f,DIALOG_ADS.HARVEST_SUCCESS)}x["for"]="steal",x.plantId=b.id,b.status=E.NONE,b.ele&&b.ele.attr("src","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="),a.remove(),p(),d&&d(e.amount),delete F[b.id]}else c||w(x,DIALOG_TEXT.FAIL,DIALOG_ADS.FAIL),d&&d(0);a.removeClass("clicked"),hideToast()},error:function(){hideToast(),a.removeClass("clicked"),c||w(x,DIALOG_TEXT.FAIL,DIALOG_ADS.FAIL),d&&d(0)}}))}function n(a,b){return a.hasClass("clicked")?!1:($(a).addClass("clicked"),showToast(),x||(x=u("")),void $.ajax({url:ctx+"/eradicate/"+b.id+"?_="+(new Date).getTime(),type:"get",dataType:"json",data:{plantId:b.id},success:function(c){c&&c.success?(w(x,DIALOG_TEXT.ERADICATE_SUCCESS,DIALOG_ADS.ERADICATE_SUCCESS),b.status=E.NONE,x["for"]="eradicate",x.plantId=b.id,a.remove(),b.ele&&b.ele.attr("src","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="),delete F[b.id]):w(x,DIALOG_TEXT.FAIL,DIALOG_ADS.FAIL),a.removeClass("clicked"),hideToast()},error:function(){hideToast(),a.removeClass("clicked")}}))}function o(a){var b=ctx+"/getMinMatureTime?_="+(new Date).getTime();ajaxData(b,null,function(b){a(b)},null,"GET")}function p(){var a=ctx+"/getUserFlow?_="+(new Date).getTime();ajaxData(a,null,function(a){$("#user_flow").html(a.flow),$("#user_exp").html(a.exp)},null,"GET")}function q(a){return a.status==E.NEED_ERADICATE?baseUrl+D[5]:baseUrl+D[a.growthStatus]}function r(a){var b=$('<div class="modal fade text-center" data-backdrop="static"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"></div><div class="modal-text"></div><div class="modal-tools"><a class="btn btn-img">确 定</a></div></div></div></div>');a&&a(b),G++,b.attr("id","dialog_"+G);var c=document.documentElement.clientWidth,d=.85*c,e=1.0945*d;return $(".modal-dialog",b).height(e),$("body").append(b),b}function s(a){var b=$('<div class="modal fade text-center" data-backdrop="static"><div class="modal-dialog"><div class="modal-content"><div class="modal-body"></div><div class="modal-text"></div><div class="modal-tools"><a class="btn btn-img">关 闭</a></div></div></div></div>');a&&a(b),b.attr("id","share_dialog-water");var c=document.documentElement.clientWidth,d=.85*c,e=d;return $(".modal-dialog",b).height(e),b.modal(),$(".btn",b).on("tap",function(){window.afterCloseShareDialog&&window.afterCloseShareDialog(),b.modal("hide")}),$("body").append(b),b}function t(){var b=r(function(a){$(".modal-body",a).hide(),$(".modal-text",a).append("欢迎您来到流量农场！每天不定时发放流量种子，快试试您的运气吧！"),$(".modal-text",a).css({padding:"20px","text-align":"left","line-height":"1.7","text-indent":"4rem"})});b.modal(),b.modal("show"),$(".btn",b).on("tap",function(){B||(B=!0,b.modal("hide"),a())})}function u(b,c){var d=r(function(a){$(".modal-text",a).append(b),c&&($(".modal-tools",a).empty(),$(".modal-tools",a).append('<div class="buttons-wrap"><a class="btn btn-ok">邀请好友</a><a class="btn btn-cancel">以后再说</a></div>'))});return d.modal(),$(".btn",d).on("tap",function(){d.modal("hide"),$(this).hasClass("btn-img")&&("steal"===d["for"]||"eradicate"===d["for"])&&window.setTimeout(function(){a(d.plantId)},600)}),$(".btn-ok",d).on("tap",function(){v()}),d}function v(){z||(z=s()),w(z,DIALOG_TEXT.WATER_SHARE,DIALOG_ADS.WATER_SHARE),window.afterWater&&afterWater()}function w(a,b,c){a||(a=u(""));var d=$(".modal-body img",a).attr("src");d!=c.img&&($(".modal-body",a).empty(),$(".modal-body",a).append('<a href="'+c.link+'" target="_blank"><img src="'+c.img+'"></a>')),$(".modal-text",a).html(b),a.modal("show")}var x,y,z,A={harvest:baseUrl+"icon-hand.png",water:baseUrl+"icon-water.png",eradicate:baseUrl+"icon-eradicate.png"},B=!1,C=!1,D=["plant1.png","plant2.png","plant3.png","plant4.png","plant5.png","plant6.png"],E={NEED_WATER:"0",NEED_HARVEST:"1",NEED_ERADICATE:"2",NONE:"-1"},F={};$(function(){return isBind?(c(function(a){a.isNewUser?(sessionStorage.getItem("receivePlant")||t(),hideToast()):b(),C=a.shared}),void e()):(window.location.href="./bind",!1)});var G=0;window.hideGuideDialog=function(){z.modal("hide")}}();